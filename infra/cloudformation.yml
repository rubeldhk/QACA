AWSTemplateFormatVersion: '2010-09-09'
Description: Bloomex QA Automation On-Demand (viewer + ALB + runner trigger). Clean template.

Parameters:
  ProjectName:
    Type: String
    Default: bloomex-qa-automation
    Description: Project tag prefix for all resources.
  EnvironmentName:
    Type: String
    Default: nonprod
    AllowedValues: [nonprod, prod]
    Description: Environment tag.
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to host the ALB and EC2 instances.
  PublicSubnets:
    Type: List<AWS::EC2::Subnet::Id>
    Description: At least two public subnets in different AZs for ALB and EC2.
  ViewerInstanceType:
    Type: String
    Default: t3.small
    Description: Instance type for always-on report viewer.
  ViewerAmiId:
    Type: AWS::EC2::Image::Id
    Description: AMI for the viewer EC2.
  KeyPairName:
    Type: String
    Default: ""
    Description: Optional key pair for EC2 troubleshooting (leave empty to disable SSH).
  ArtifactBucketName:
    Type: String
    Description: Existing S3 bucket containing automation-artifact.zip (you already created this).
  ArtifactZipKey:
    Type: String
    Default: automation-artifact.zip
    Description: Key in ArtifactBucketName for the artifact zip.
  ReportsBucketName:
    Type: String
    Description: Existing S3 bucket for reports (Allure history + last runs). Viewer syncs from this bucket.
  RunnerAmiId:
    Type: AWS::EC2::Image::Id
    Description: AMI for the on-demand runner EC2.
  RunnerMode:
    Type: String
    Default: start-stopped
    AllowedValues:
      - start-stopped
      - ephemeral
    Description: Runner lifecycle mode. "start-stopped" reuses a persistent instance; "ephemeral" launches new instances.
  RunnerInstanceType:
    Type: String
    Default: t3.large
    Description: Default compute for on-demand runner.
  RunnerSubnetId:
    Type: String
    Default: ""
    Description: Subnet ID for runner instances (leave empty to use the first PublicSubnets entry).
  RunnerSecurityGroupId:
    Type: String
    Default: ""
    Description: Security group ID for runner instances (leave empty to create/manage one in this stack).
  RunnerInstanceProfileArn:
    Type: String
    Default: ""
    Description: Instance profile ARN for runner instances (leave empty to create/manage one in this stack).
  RunnerInstanceRoleArn:
    Type: String
    Default: ""
    Description: Role ARN backing the runner instance profile (required if RunnerInstanceProfileArn is provided).
  RunnerKeyName:
    Type: String
    Default: ""
    Description: Optional key pair for runner EC2 (leave empty to disable SSH).
  RunnerCommandTemplate:
    Type: String
    Default: "sudo /opt/qaca/run.sh --env {env} --group {testGroup} --locale {locale}"
    Description: Command template executed via SSM. Supports {env}, {testGroup}, and {locale} placeholders.
  RunnerTagProject:
    Type: String
    Default: bloomex-ca-qa-automation
    Description: Project tag value for runner discovery.
  RunnerTagRole:
    Type: String
    Default: runner
    Description: Role tag value for runner discovery.
  AllowedEnvironments:
    Type: String
    Default: nonprod
    Description: Comma-delimited list of allowed env values for the trigger Lambda.
  QacaToken:
    Type: String
    NoEcho: true
    Description: Shared token required by the trigger Lambda.

Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, ""]]
  HasRunnerKeyPair: !Not [!Equals [!Ref RunnerKeyName, ""]]
  RunnerModeStartStopped: !Equals [!Ref RunnerMode, "start-stopped"]
  UseProvidedRunnerSubnet: !Not [!Equals [!Ref RunnerSubnetId, ""]]
  UseProvidedRunnerSecurityGroup: !Not [!Equals [!Ref RunnerSecurityGroupId, ""]]
  UseProvidedRunnerProfile: !Not [!Equals [!Ref RunnerInstanceProfileArn, ""]]
  UseProvidedRunnerRole: !Not [!Equals [!Ref RunnerInstanceProfileArn, ""]]
  CreateRunnerProfile: !Equals [!Ref RunnerInstanceProfileArn, ""]
  CreateRunnerSecurityGroup: !Equals [!Ref RunnerSecurityGroupId, ""]

Rules:
  RunnerProfileRequiresRole:
    Assertions:
      - Assert: !Or
          - !Equals [!Ref RunnerInstanceProfileArn, ""]
          - !Not [!Equals [!Ref RunnerInstanceRoleArn, ""]]
        AssertDescription: RunnerInstanceRoleArn is required when RunnerInstanceProfileArn is provided.

Resources:
  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${ProjectName}-${EnvironmentName}-alb-sg"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-alb-sg"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName

  ViewerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow ALB to reach viewer
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref AlbSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-viewer-sg"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName

  Alb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Type: application
      IpAddressType: ipv4
      Subnets: !Ref PublicSubnets
      SecurityGroups:
        - !Ref AlbSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-alb"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName

  AlbTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !Ref VpcId
      Protocol: HTTP
      Port: 80
      TargetType: instance
      HealthCheckProtocol: HTTP
      HealthCheckPath: /
      Matcher:
        HttpCode: "200-399"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-viewer-tg"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName

  AlbListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref Alb
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref AlbTargetGroup

  ViewerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ViewerS3ReportsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${ReportsBucketName}"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub "arn:aws:s3:::${ReportsBucketName}/*"
        - PolicyName: ViewerElbRegister
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - elasticloadbalancing:RegisterTargets
                  - elasticloadbalancing:DeregisterTargets
                Resource: "*"
        - PolicyName: ViewerLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName

  ViewerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref ViewerRole

  ViewerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref ViewerAmiId
      InstanceType: !Ref ViewerInstanceType
      SubnetId: !Select [0, !Ref PublicSubnets]
      SecurityGroupIds:
        - !Ref ViewerSecurityGroup
      IamInstanceProfile: !Ref ViewerInstanceProfile
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref "AWS::NoValue"]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-viewer"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail

          dnf -y update
          dnf -y install nginx awscli jq
          systemctl enable nginx
          systemctl start nginx

          # Pull QA UI page from artifact bucket
          aws s3 cp s3://${ArtifactBucketName}/qaautomation.html /usr/share/nginx/html/qaautomation.html || true
          cp -f /usr/share/nginx/html/qaautomation.html /usr/share/nginx/html/index.html || true

          mkdir -p /usr/share/nginx/html/reports
          cat >/etc/nginx/conf.d/reports.conf <<'EOF'
          server {
            listen 80 default_server;
            server_name _;
            root /usr/share/nginx/html;
            location / {
              try_files $uri $uri/ =404;
            }
          }
          EOF
          nginx -t && systemctl restart nginx

          # Register this instance into the ALB target group
          IID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
          aws elbv2 register-targets --region ${AWS::Region} --target-group-arn ${AlbTargetGroup} --targets Id=$IID,Port=80 || true

          # Initial sync
          aws s3 sync s3://${ReportsBucketName}/reports/ /usr/share/nginx/html/reports/ --delete || true

          # Cron: refresh every 2 minutes (reports + UI)
          cat >/etc/cron.d/qaca-sync <<EOF
          */2 * * * * root aws s3 sync s3://${ReportsBucketName}/reports/ /usr/share/nginx/html/reports/ --delete >/var/log/reports-sync.log 2>&1
          */2 * * * * root aws s3 cp s3://${ArtifactBucketName}/qaautomation.html /usr/share/nginx/html/qaautomation.html && cp -f /usr/share/nginx/html/qaautomation.html /usr/share/nginx/html/index.html >/var/log/qaui-sync.log 2>&1
          EOF

  RunnerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateRunnerSecurityGroup
    Properties:
      GroupDescription: Runner outbound only
      VpcId: !Ref VpcId
      SecurityGroupIngress: []
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-runner-sg"
        - Key: Project
          Value: !Ref RunnerTagProject
        - Key: Environment
          Value: !Ref EnvironmentName

  RunnerInstanceRole:
    Type: AWS::IAM::Role
    Condition: CreateRunnerProfile
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: RunnerS3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: [s3:GetObject, s3:ListBucket]
                Resource:
                  - !Sub "arn:aws:s3:::${ArtifactBucketName}"
                  - !Sub "arn:aws:s3:::${ArtifactBucketName}/*"
              - Effect: Allow
                Action: [s3:PutObject, s3:DeleteObject, s3:GetObject, s3:ListBucket]
                Resource:
                  - !Sub "arn:aws:s3:::${ReportsBucketName}"
                  - !Sub "arn:aws:s3:::${ReportsBucketName}/*"
        - PolicyName: RunnerSelfTerminate
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: [ec2:TerminateInstances, ec2:StopInstances, ec2:DescribeInstances]
                Resource: "*"
        - PolicyName: RunnerLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: [logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents]
                Resource: "*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref EnvironmentName

  RunnerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: CreateRunnerProfile
    Properties:
      Roles:
        - !Ref RunnerInstanceRole

  RunnerInstance:
    Type: AWS::EC2::Instance
    Condition: RunnerModeStartStopped
    Properties:
      ImageId: !Ref RunnerAmiId
      InstanceType: !Ref RunnerInstanceType

      SubnetId: !If
        - UseProvidedRunnerSubnet
        - !Ref RunnerSubnetId
        - !Select [0, !Ref PublicSubnets]

      SecurityGroupIds:
        - !If
          - UseProvidedRunnerSecurityGroup
          - !Ref RunnerSecurityGroupId
          - !Ref RunnerSecurityGroup

      # EC2 expects instance-profile NAME (not ARN)
      IamInstanceProfile: !If
        - UseProvidedRunnerProfile
        - !Select [1, !Split ["/", !Ref RunnerInstanceProfileArn]]
        - !Ref RunnerInstanceProfile

      KeyName: !If
        - HasRunnerKeyPair
        - !Ref RunnerKeyName
        - !Ref AWS::NoValue

      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${EnvironmentName}-runner"
        - Key: Project
          Value: !Ref RunnerTagProject
        - Key: Role
          Value: !Ref RunnerTagRole
        - Key: Env
          Value: !Ref EnvironmentName

      UserData:
        Fn::Base64: |
          #!/bin/bash
          set -euxo pipefail
          shutdown -h now

  TriggerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: TriggerRunnerControl
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:RunInstances
                  - ec2:CreateTags
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - ec2:TerminateInstances
                Resource: "*"
              - Effect: Allow
                Action: iam:PassRole
                Resource: !If
                  - UseProvidedRunnerRole
                  - !Ref RunnerInstanceRoleArn
                  - !GetAtt RunnerInstanceRole.Arn
              - Effect: Allow
                Action:
                  - ssm:SendCommand
                Resource:
                  - arn:aws:ssm:*:*:document/AWS-RunShellScript
                  - arn:aws:ec2:*:*:instance/*
                Condition:
                  StringEquals:
                    ssm:resourceTag/Project: !Ref RunnerTagProject
                    ssm:resourceTag/Role: !Ref RunnerTagRole
              - Effect: Allow
                Action:
                  - ssm:GetCommandInvocation
                  - ssm:ListCommandInvocations
                Resource: "*"

  TriggerLambda:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt TriggerLambdaRole.Arn
      Timeout: 60
      Environment:
        Variables:
          QACA_TOKEN: !Ref QacaToken
          RUNNER_MODE: !Ref RunnerMode
          RUNNER_INSTANCE_TYPE: !Ref RunnerInstanceType
          RUNNER_SUBNET_ID: !If [UseProvidedRunnerSubnet, !Ref RunnerSubnetId, !Select [0, !Ref PublicSubnets]]
          RUNNER_SECURITY_GROUP_ID: !If [UseProvidedRunnerSecurityGroup, !Ref RunnerSecurityGroupId, !Ref RunnerSecurityGroup]
          RUNNER_AMI_ID: !Ref RunnerAmiId
          RUNNER_INSTANCE_PROFILE_ARN: !If [UseProvidedRunnerProfile, !Ref RunnerInstanceProfileArn, !GetAtt RunnerInstanceProfile.Arn]
          RUNNER_KEY_NAME: !Ref RunnerKeyName
          RUNNER_COMMAND_TEMPLATE: !Ref RunnerCommandTemplate
          RUNNER_TAG_PROJECT: !Ref RunnerTagProject
          RUNNER_TAG_ROLE: !Ref RunnerTagRole
          ALLOWED_ENVS: !Ref AllowedEnvironments
      Code:
        ZipFile: |
          import json
          import os
          import time
          import boto3

          ec2 = boto3.client("ec2")
          ssm = boto3.client("ssm")


          def handler(event, ctx):
              try:
                  print("Received event:", json.dumps(event))
                  _validate_token(event)
                  payload = _parse_payload(event)
                  env = (payload.get("env") or "nonprod").strip()
                  test_group = (payload.get("testGroup") or "").strip()
                  locale = (payload.get("locale") or "en-CA").strip()

                  _validate_inputs(env, test_group, locale)

                  mode = os.environ.get("RUNNER_MODE", "start-stopped")
                  print(f"Runner mode: {mode}")

                  if mode == "ephemeral":
                      instance_id = _launch_ephemeral_runner(env, test_group)
                  else:
                      instance_id = _find_or_start_runner(env)

                  command_id = _send_ssm_command(instance_id, env, test_group, locale)

                  response = {
                      "message": "invoked",
                      "mode": mode,
                      "runnerInstanceId": instance_id,
                      "ssmCommandId": command_id,
                      "env": env,
                      "testGroup": test_group,
                      "locale": locale,
                  }
                  print("Invocation response:", json.dumps(response))
                  return response
              except Exception as exc:
                  print(f"Trigger failed: {exc}")
                  raise


          def _parse_payload(event):
              if isinstance(event, str):
                  try:
                      return json.loads(event)
                  except json.JSONDecodeError:
                      return {}

              if not isinstance(event, dict):
                  return {}

              body = event.get("body")
              if body is None:
                  return event
              if isinstance(body, str):
                  try:
                      return json.loads(body) if body else {}
                  except json.JSONDecodeError:
                      return {}
              if isinstance(body, dict):
                  return body
              return {}


          def _validate_token(event):
              expected = os.environ.get("QACA_TOKEN")
              if not expected:
                  return
              if not isinstance(event, dict):
                  return
              headers = event.get("headers") or {}
              if not headers:
                  return
              provided = None
              for key, value in headers.items():
                  if key.lower() == "x-qaca-token":
                      provided = value
                      break
              if provided != expected:
                  raise PermissionError("Forbidden: invalid x-qaca-token")


          def _validate_inputs(env, test_group, locale):
              allowed = [item.strip() for item in os.environ.get("ALLOWED_ENVS", "nonprod").split(",") if item.strip()]
              if env not in allowed:
                  raise ValueError(f"env must be one of {allowed}")
              if not test_group:
                  raise ValueError("testGroup is required")
              if not locale:
                  raise ValueError("locale is required")


          def _runner_tag_filters(env):
              filters = [
                  {"Name": "tag:Project", "Values": [os.environ.get("RUNNER_TAG_PROJECT", "bloomex-ca-qa-automation")]},
                  {"Name": "tag:Role", "Values": [os.environ.get("RUNNER_TAG_ROLE", "runner")]},
              ]
              if env:
                  filters.append({"Name": "tag:Env", "Values": [env]})
              return filters


          def _find_or_start_runner(env):
              print("Searching for runner instance.")
              instances = _describe_instances(_runner_tag_filters(env))
              if not instances:
                  raise RuntimeError("No runner instance found for start-stopped mode.")

              instance = _select_instance(instances)
              instance_id = instance["InstanceId"]
              state = instance["State"]["Name"]
              print(f"Runner instance {instance_id} state: {state}")

              if state == "running":
                  return instance_id
              if state == "stopped":
                  print(f"Starting runner instance {instance_id}")
                  ec2.start_instances(InstanceIds=[instance_id])
                  _wait_for_state(instance_id, "running")
                  return instance_id
              if state in {"pending", "stopping"}:
                  _wait_for_state(instance_id, "running")
                  return instance_id

              raise RuntimeError(f"Runner instance {instance_id} is in unexpected state: {state}")


          def _select_instance(instances):
              priority = {"running": 0, "pending": 1, "stopped": 2, "stopping": 3, "shutting-down": 4, "terminated": 5}
              return sorted(instances, key=lambda inst: priority.get(inst["State"]["Name"], 99))[0]


          def _wait_for_state(instance_id, desired_state, timeout_seconds=300):
              print(f"Waiting for instance {instance_id} to reach {desired_state}")
              deadline = time.time() + timeout_seconds
              while time.time() < deadline:
                  instances = _describe_instances([{"Name": "instance-id", "Values": [instance_id]}])
                  if instances:
                      state = instances[0]["State"]["Name"]
                      print(f"Instance {instance_id} current state: {state}")
                      if state == desired_state:
                          return
                  time.sleep(10)
              raise TimeoutError(f"Timed out waiting for {instance_id} to reach {desired_state}")


          def _describe_instances(filters):
              response = ec2.describe_instances(Filters=filters)
              instances = []
              for reservation in response.get("Reservations", []):
                  instances.extend(reservation.get("Instances", []))
              return instances


          def _launch_ephemeral_runner(env, test_group):
              print("Launching ephemeral runner instance.")
              tags = [
                  {"Key": "Name", "Value": f"qa-runner-{test_group}"},
                  {"Key": "Project", "Value": os.environ.get("RUNNER_TAG_PROJECT", "bloomex-ca-qa-automation")},
                  {"Key": "Role", "Value": os.environ.get("RUNNER_TAG_ROLE", "runner")},
                  {"Key": "Env", "Value": env},
              ]
              params = {
                  "ImageId": os.environ["RUNNER_AMI_ID"],
                  "InstanceType": os.environ.get("RUNNER_INSTANCE_TYPE", "t3.large"),
                  "MinCount": 1,
                  "MaxCount": 1,
                  "SubnetId": os.environ["RUNNER_SUBNET_ID"],
                  "SecurityGroupIds": [os.environ["RUNNER_SECURITY_GROUP_ID"]],
                  "TagSpecifications": [{"ResourceType": "instance", "Tags": tags}],
              }
              key_name = os.environ.get("RUNNER_KEY_NAME")
              if key_name:
                  params["KeyName"] = key_name
              response = ec2.run_instances(**params)
              instance_id = response["Instances"][0]["InstanceId"]
              _wait_for_state(instance_id, "running")
              return instance_id


          def _send_ssm_command(instance_id, env, test_group, locale):
              template = os.environ.get("RUNNER_COMMAND_TEMPLATE", "sudo /opt/qaca/run.sh --env {env} --group {testGroup} --locale {locale}")
              command = template.format(env=env, testGroup=test_group, locale=locale)
              print(f"Sending SSM command to {instance_id}: {command}")
              response = ssm.send_command(
                  InstanceIds=[instance_id],
                  DocumentName="AWS-RunShellScript",
                  Parameters={"commands": [command]},
              )
              command_id = response["Command"]["CommandId"]
              print(f"SSM command accepted: {command_id}")
              return command_id

  TriggerFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      TargetFunctionArn: !Ref TriggerLambda
      AuthType: NONE

  TriggerUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunctionUrl
      FunctionName: !Ref TriggerLambda
      Principal: "*"
      FunctionUrlAuthType: 'NONE'

Outputs:
  AlbDnsName:
    Description: ALB DNS name for report viewer
    Value: !GetAtt Alb.DNSName
  TriggerUrl:
    Description: Function URL to trigger a runner launch
    Value: !GetAtt TriggerFunctionUrl.FunctionUrl
  TriggerLambdaName:
    Description: Trigger Lambda function name
    Value: !Ref TriggerLambda
  TriggerLambdaArn:
    Description: Trigger Lambda function ARN
    Value: !GetAtt TriggerLambda.Arn
  ReportsBucketNameOut:
    Description: Reports bucket used by viewer and runner
    Value: !Ref ReportsBucketName
  ArtifactBucketNameOut:
    Description: Artifact bucket containing automation-artifact.zip
    Value: !Ref ArtifactBucketName
  RunnerModeOut:
    Description: Runner lifecycle mode
    Value: !Ref RunnerMode
  RunnerAmiIdOut:
    Description: Runner AMI ID
    Value: !Ref RunnerAmiId
  RunnerSubnetIdOut:
    Description: Runner subnet ID
    Value: !If [UseProvidedRunnerSubnet, !Ref RunnerSubnetId, !Select [0, !Ref PublicSubnets]]
  RunnerSecurityGroupIdOut:
    Description: Runner security group ID
    Value: !If [UseProvidedRunnerSecurityGroup, !Ref RunnerSecurityGroupId, !Ref RunnerSecurityGroup]
  RunnerInstanceProfileArnOut:
    Description: Runner instance profile ARN
    Value: !If [UseProvidedRunnerProfile, !Ref RunnerInstanceProfileArn, !GetAtt RunnerInstanceProfile.Arn]
  RunnerInstanceRoleArnOut:
    Description: Runner instance role ARN
    Value: !If [UseProvidedRunnerRole, !Ref RunnerInstanceRoleArn, !GetAtt RunnerInstanceRole.Arn]
  RunnerInstanceTypeOut:
    Description: Runner instance type
    Value: !Ref RunnerInstanceType
  RunnerCommandTemplateOut:
    Description: Runner command template executed via SSM
    Value: !Ref RunnerCommandTemplate
