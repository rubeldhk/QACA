<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bloomex QA Automation On-Demand</title>
  <style>
    :root {
      --bg: #0c1220;
      --panel: #111827;
      --accent: #38bdf8;
      --accent-2: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --fail: #ef4444;
      --warn: #f59e0b;
      --pass: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.08), rgba(34,197,94,0.04)), var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    h1 { margin: 0; font-size: 26px; letter-spacing: 0.5px; }
    .sub { color: var(--muted); margin-top: 4px; font-size: 14px; }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      width: 100%;
      max-width: 720px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 13px; }
    select, button, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-size: 14px;
    }
    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      transition: transform 0.08s ease, opacity 0.08s ease;
    }
    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(90deg, var(--accent), #6366f1); color: #0b1120; }
    .btn-ghost { background: rgba(255,255,255,0.06); }
    .grid { display: grid; gap: 14px; padding: 0 24px 24px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { background: var(--panel); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.4px; }
    .badge-env { background: rgba(56,189,248,0.15); color: #7dd3fc; }
    .badge-locale { background: rgba(34,197,94,0.15); color: #86efac; }
    .status { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .dot.pass { background: var(--pass); }
    .dot.fail { background: var(--fail); }
    .dot.running { background: var(--warn); }
    .muted { color: var(--muted); font-size: 13px; }
    .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .compare-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; }
    .pill { padding: 6px 10px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
    .run-status { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(17,24,39,0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.06); padding: 14px 20px; display: none; flex-direction: column; gap: 6px; }
    .run-status.show { display: flex; }
    .link-btn { color: var(--accent); text-decoration: none; font-weight: 600; }
    .columns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    iframe { width: 100%; height: 70vh; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; background: #fff; }
    @media(max-width: 768px) { iframe { height: 50vh; } .columns { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Bloomex QA Automation On-Demand</h1>
      <div class="sub">Trigger Playwright runs straight from your browser. The Function URL is protected by a shared token.</div>
    </div>
  </header>

  <main class="grid" style="padding-bottom:120px;">
    <section class="panel">
      <h3 style="margin-top:0;">Launch a run</h3>
      <p class="muted" style="margin-top:4px;">Select a group and locale, then click Run QA. The request is sent via the Function URL using a shared header token.</p>
      <div class="filters" style="margin-top:14px;">
        <div>
          <label for="group">Group</label>
          <select id="group">
            <option value="smoke">Smoke</option>
            <option value="regression">Regression</option>
            <option value="checkout">Checkout</option>
          </select>
        </div>
        <div>
          <label for="locale">Locale</label>
          <select id="locale">
            <option value="en">English (en)</option>
            <option value="fr">French (fr)</option>
          </select>
        </div>
        <div>
          <label for="token">Shared token</label>
          <input id="token" type="text" placeholder="Paste QACA token" autocomplete="off" />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button class="btn-primary" id="runBtn" style="max-width:180px;">Run QA</button>
        <button class="btn-ghost" id="clearBtn" style="max-width:140px;">Clear</button>
      </div>
      <div id="result" class="muted" style="margin-top:14px;"></div>
    </section>

    <section class="panel">
      <h3 style="margin-top:0;">Reports</h3>
      <p class="muted" style="margin-top:4px;">Quick access to the latest and previous reports for the selected group and locale.</p>
      <div class="filters" style="margin-top:14px;">
        <div>
          <label for="reportGroup">Group</label>
          <select id="reportGroup">
            <option value="smoke">Smoke</option>
            <option value="regression">Regression</option>
            <option value="checkout">Checkout</option>
          </select>
        </div>
        <div>
          <label for="reportLocale">Locale</label>
          <select id="reportLocale">
            <option value="en">English (en)</option>
            <option value="fr">French (fr)</option>
          </select>
        </div>
      </div>
      <div class="actions" style="margin-top:16px;">
        <a id="latestLink" class="btn-primary" href="#" target="_blank" rel="noopener">Open Latest Report</a>
        <a id="prevLink" class="btn-ghost link-btn" href="#" target="_blank" rel="noopener">Open Previous Report</a>
      </div>
      <p class="muted" style="margin-top:12px;">Update <code>viewerBaseUrl</code> in the script to match the deployed viewer hostname.</p>
    </section>
  </main>

  <div class="run-status" id="runStatus"></div>

  <script>
    const triggerUrl = 'REPLACE_WITH_FUNCTION_URL';
    const viewerBaseUrl = 'https://viewer.example.com'; // Set to ALB DNS or custom domain.

    function buildReportLinks() {
      const group = document.getElementById('reportGroup').value;
      const locale = document.getElementById('reportLocale').value;
      const latest = `${viewerBaseUrl}/reports/nonprod/${locale}/${group}/latest/index.html`;
      const previous = `${viewerBaseUrl}/reports/nonprod/${locale}/${group}/prev/index.html`;
      document.getElementById('latestLink').href = latest;
      document.getElementById('prevLink').href = previous;
    }

    function setStatus(message, isError = false) {
      const result = document.getElementById('result');
      result.textContent = message;
      result.style.color = isError ? 'var(--fail)' : 'var(--muted)';
    }

    function formattedRunId() {
      const now = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    }

    async function triggerRun() {
      const group = document.getElementById('group').value;
      const locale = document.getElementById('locale').value;
      const token = document.getElementById('token').value.trim();
      if (!token) {
        setStatus('Token is required to trigger the run.', true);
        return;
      }

      const payload = {
        env: 'nonprod',
        locale,
        group,
        runId: formattedRunId(),
      };

      setStatus(`Sending request for ${group} (${locale})...`);

      try {
        const res = await fetch(triggerUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-qaca-token': token,
          },
          body: JSON.stringify(payload),
        });

        if (res.status === 401) {
          setStatus('Unauthorized: token rejected.', true);
          return;
        }

        if (!res.ok) {
          setStatus(`Failed: HTTP ${res.status}`, true);
          return;
        }

        const data = await res.json();
        setStatus(`Success! ${data.message}. Instance: ${data.instanceId}`);
      } catch (err) {
        setStatus(`Error triggering run: ${err.message}`, true);
      }
    }

    document.getElementById('runBtn').addEventListener('click', triggerRun);
    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('token').value = '';
      setStatus('');
    });

    document.getElementById('reportGroup').addEventListener('change', buildReportLinks);
    document.getElementById('reportLocale').addEventListener('change', buildReportLinks);
    buildReportLinks();
  </script>
</body>
</html>
