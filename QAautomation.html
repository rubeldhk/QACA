<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QA Automation Trigger</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #38bdf8;
      --accent-2: #22c55e;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --danger: #ef4444;
      --border: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 25% 20%, rgba(56, 189, 248, 0.08), rgba(34, 197, 94, 0.05)), var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 24px;
    }

    .card {
      width: min(640px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      letter-spacing: 0.3px;
    }

    p.sub {
      margin: 0 0 18px;
      color: var(--muted);
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 4px;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      color: #0b1120;
      background: linear-gradient(90deg, var(--accent), #6366f1);
      transition: transform 0.08s ease, opacity 0.1s ease;
    }

    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }

    .status-box {
      margin-top: 16px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-height: 96px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 13px;
    }

    .status-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      display: inline-block;
      background: var(--accent);
    }

    .dot.ok { background: var(--accent-2); }
    .dot.err { background: var(--danger); }
  </style>
</head>
<body>
  <main class="card">
    <h1>QA Automation On-Demand</h1>
    <p class="sub">Launch QA runs through the ALB-protected trigger endpoint.</p>

    <div class="grid">
      <div>
        <label for="token">Token (x-qaca-token)</label>
        <input id="token" type="password" autocomplete="off" placeholder="Required" />
      </div>
      <div>
        <label for="group">Test Group</label>
        <select id="group">
          <option value="QAATG01">QAATG01</option>
          <option value="QAATG02">QAATG02</option>
          <option value="QAATG03">QAATG03</option>
        </select>
      </div>
      <div>
        <label for="locale">Locale</label>
        <select id="locale">
          <option value="en">en</option>
          <option value="fr">fr</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="runBtn" type="button">RUN</button>
      <span style="color: var(--muted); font-size: 13px;">Payload env is fixed to <strong>nonprod</strong>.</span>
    </div>

    <div class="status-box" id="statusBox">
      <div class="status-title"><span class="dot"></span><span>Waiting to run.</span></div>
      <div id="statusText">Fill in the token, choose a group and locale, then click RUN.</div>
    </div>
  </main>

  <script>
    const runBtn = document.getElementById('runBtn');
    const tokenInput = document.getElementById('token');
    const groupSelect = document.getElementById('group');
    const localeSelect = document.getElementById('locale');
    const statusBox = document.getElementById('statusBox');
    const statusTitle = statusBox.querySelector('.status-title');
    const statusText = document.getElementById('statusText');

    function setStatus(message, type = 'info') {
      const dot = statusTitle.querySelector('.dot');
      dot.className = 'dot';
      if (type === 'ok') dot.classList.add('ok');
      if (type === 'error') dot.classList.add('err');
      statusText.textContent = message;
    }

    async function triggerRun() {
      const token = tokenInput.value.trim();
      if (!token) {
        setStatus('Token is required to trigger a run.', 'error');
        return;
      }

      const payload = {
        env: 'nonprod',
        locale: localeSelect.value,
        groupId: groupSelect.value
      };

      runBtn.disabled = true;
      setStatus('Submitting request to /trigger ...');

      try {
        const response = await fetch('/trigger', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-qaca-token': token
          },
          body: JSON.stringify(payload)
        });

        const bodyText = await response.text();
        let data;
        try { data = bodyText ? JSON.parse(bodyText) : null; } catch (_) { data = null; }

        if (response.status === 401 || response.status === 403) {
          setStatus('Invalid token. Access denied by trigger endpoint.', 'error');
          return;
        }

        if (response.status >= 500) {
          setStatus(`Server error (${response.status}). Please try again.`, 'error');
          return;
        }

        if (response.ok) {
          const parts = [];
          const message = data && (data.message || data.status || data.result) ? (data.message || data.status || data.result) : 'Request accepted.';
          parts.push(message);
          if (data && (data.awsCliOutput || data.output)) {
            parts.push('AWS CLI Output:\n' + (data.awsCliOutput || data.output));
          } else if (!data && bodyText) {
            parts.push(bodyText);
          }
          setStatus(parts.join('\n\n'), 'ok');
          return;
        }

        const fallback = data && (data.message || data.error) ? `${data.message || data.error}` : bodyText || 'Request failed.';
        setStatus(`Request failed (${response.status}). ${fallback}`, 'error');
      } catch (err) {
        setStatus(`Network or fetch error: ${err.message}`, 'error');
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener('click', triggerRun);
  </script>
</body>
</html>
